#!/bin/bash

if grep -q 'listen 80;' /etc/nginx/sites-available/default; then
    sed -i 's/listen 80;/listen 8080;/g' /etc/nginx/sites-available/default
else
    echo "Nginx is not configured to listen on port 80 in /etc/nginx/sites-available/default"
    exit 1
fi

if grep -q 'user www-data;' /etc/nginx/nginx.conf; then
    sed -i 's/user www-data;/user nginx;/g' /etc/nginx/nginx.conf
else
    echo "Nginx is not configured to run as user www-data in /etc/nginx/nginx.conf"
    exit 1
fi

systemctl restart nginx

if ps aux | grep '[n]ginx' | grep -q 'nginx'; then
    echo "Nginx is running as nginx user."
else
    echo "Nginx is not running as nginx user."
    exit 1
fi

if nc -z 0 8080; then
    echo "Nginx is listening on port 8080."
else
    echo "Nginx is not listening on port 8080."
    exit 1
fi
